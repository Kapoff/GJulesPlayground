<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Meal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button id="globalShutdownBtn" class="global-shutdown-button" title="Shutdown Server">
        &times; <!-- This is the 'X' symbol -->
        <span class="tooltip-text">Shutdown Server</span>
    </button>

    <div class="container">
        <header>
            <h1>Track Your Meal</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('add_ingredient_page') }}" class="nav-link">Add Ingredient</a>
            </nav>
        </header>

        <section id="mealCompositionSection">
            <h2>Compose Your Meal</h2>
            <div class="form-group">
                <label for="mealName">Meal Name:</label>
                <input type="text" id="mealName" name="mealName" value="My Custom Meal">
            </div>

            <div class="ingredient-selector">
                <div class="form-group">
                    <label for="ingredientSearch">Select Ingredient:</label>
                    <input type="text" id="ingredientSearch" placeholder="Search ingredients...">
                    <select id="ingredientSelect" name="ingredientSelect" size="5"></select>
                </div>
                <div class="form-group">
                    <label for="ingredientWeight">Weight (grams):</label>
                    <input type="number" id="ingredientWeight" name="ingredientWeight" min="0" step="0.1" placeholder="e.g., 150">
                </div>
                <button id="addIngredientToMealBtn" class="button">Add to Meal</button>
            </div>
            <div id="mealIngredientStatus" class="status-message" style="margin-top: 10px;"></div>
        </section>

        <section id="currentMealSection">
            <h2>Current Meal Ingredients</h2>
            <ul id="currentMealList">
                <!-- Ingredients will be listed here by JavaScript -->
            </ul>
            <button id="calculateNutritionBtn" class="button primary-action" disabled>Calculate Nutrition</button>
        </section>

        <section id="nutritionResultsSection" style="display:none;">
            <h2>Nutritional Information for <span id="resultMealName"></span></h2>
            <div id="nutritionStatus" class="status-message"></div>
            <h3>Total Meal Nutrition:</h3>
            <table id="totalNutritionTable">
                <thead>
                    <tr>
                        <th>Nutrient</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>

            <h3>Nutrition per 100g of Meal:</h3>
            <table id="per100gNutritionTable">
                <thead>
                    <tr>
                        <th>Nutrient</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        const mealNameInput = document.getElementById('mealName');
        const ingredientSearch = document.getElementById('ingredientSearch');
        const ingredientSelect = document.getElementById('ingredientSelect');
        const ingredientWeightInput = document.getElementById('ingredientWeight');
        const addIngredientToMealBtn = document.getElementById('addIngredientToMealBtn');
        const currentMealList = document.getElementById('currentMealList');
        const calculateNutritionBtn = document.getElementById('calculateNutritionBtn');
        const nutritionResultsSection = document.getElementById('nutritionResultsSection');
        const resultMealName = document.getElementById('resultMealName');
        const totalNutritionTableBody = document.getElementById('totalNutritionTable').getElementsByTagName('tbody')[0];
        const per100gNutritionTableBody = document.getElementById('per100gNutritionTable').getElementsByTagName('tbody')[0];
        const mealIngredientStatus = document.getElementById('mealIngredientStatus');
        const nutritionStatus = document.getElementById('nutritionStatus');

        let availableIngredients = [];
        let currentMeal = []; // Array of {name, weight, originalData}

        async function fetchIngredients() {
            try {
                const response = await fetch('/api/get_ingredients');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                availableIngredients = await response.json();
                populateIngredientSelect(availableIngredients);
            } catch (error) {
                console.error('Error fetching ingredients:', error);
                mealIngredientStatus.textContent = 'Error loading ingredients. Please try refreshing.';
                mealIngredientStatus.className = 'status-message error';
            }
        }

        function populateIngredientSelect(ingredients) {
            ingredientSelect.innerHTML = ''; // Clear existing options
            ingredients.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.name;
                option.textContent = ing.name; // Display only the name

                // Create tooltip content
                const tooltipText = `Calories: ${ing.calories.toFixed(1)} kcal\nProtein: ${ing.protein.toFixed(1)} g\nCarbs: ${ing.carbs.toFixed(1)} g\nFat: ${ing.fat.toFixed(1)} g\n(per 100g)`;
                option.title = tooltipText; // Use the native title attribute for simple tooltips

                ingredientSelect.appendChild(option);
            });
        }

        ingredientSearch.addEventListener('input', () => {
            const searchTerm = ingredientSearch.value.toLowerCase();
            const filteredIngredients = availableIngredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));
            populateIngredientSelect(filteredIngredients);
        });

        addIngredientToMealBtn.addEventListener('click', () => {
            const selectedOption = ingredientSelect.options[ingredientSelect.selectedIndex];
            const weight = parseFloat(ingredientWeightInput.value);

            mealIngredientStatus.textContent = '';
            mealIngredientStatus.className = 'status-message';

            if (!selectedOption) {
                mealIngredientStatus.textContent = 'Please select an ingredient.';
                mealIngredientStatus.className = 'status-message error';
                return;
            }
            if (isNaN(weight) || weight <= 0) {
                mealIngredientStatus.textContent = 'Please enter a valid positive weight.';
                mealIngredientStatus.className = 'status-message error';
                return;
            }

            const ingredientName = selectedOption.value;
            const ingredientData = availableIngredients.find(ing => ing.name === ingredientName);

            if (ingredientData) {
                currentMeal.push({ name: ingredientName, weight: weight, originalData: ingredientData });
                renderCurrentMeal();
                ingredientWeightInput.value = ''; // Clear weight input
                calculateNutritionBtn.disabled = false;
                mealIngredientStatus.textContent = `${ingredientName} added to meal.`;
                mealIngredientStatus.className = 'status-message success';
                 setTimeout(() => { mealIngredientStatus.textContent = ''; mealIngredientStatus.className = 'status-message';}, 3000);
            } else {
                mealIngredientStatus.textContent = 'Selected ingredient not found in available list.';
                mealIngredientStatus.className = 'status-message error';
            }
        });

        function renderCurrentMeal() {
            currentMealList.innerHTML = ''; // Clear existing list
            if (currentMeal.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No ingredients added yet.';
                currentMealList.appendChild(li);
                calculateNutritionBtn.disabled = true;
                return;
            }
            currentMeal.forEach((item, index) => {
                const li = document.createElement('li');
                li.classList.add('meal-item-row'); // For flex styling

                // Left part: Name and Weight
                const leftDiv = document.createElement('div');
                leftDiv.classList.add('meal-item-left');

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('meal-item-name');
                nameSpan.textContent = item.name;
                nameSpan.title = item.name; // For full name tooltip on hover
                leftDiv.appendChild(nameSpan);

                const weightInput = document.createElement('input');
                // Removed duplicate const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.value = item.weight;
                weightInput.min = "0.1"; // Smallest reasonable weight
                weightInput.step = "0.1";
                weightInput.classList.add('editable-weight-input'); // For styling
                weightInput.dataset.index = index; // Store index for easy update
                weightInput.addEventListener('change', (event) => handleWeightChange(event, index));
                leftDiv.appendChild(weightInput);

                const unitSpan = document.createElement('span');
                unitSpan.classList.add('meal-item-unit');
                unitSpan.textContent = "g";
                leftDiv.appendChild(unitSpan);
                li.appendChild(leftDiv);

                // Middle part: Calculated Macros (initially empty)
                const macrosDiv = document.createElement('div');
                macrosDiv.classList.add('meal-item-macros');
                macrosDiv.id = `macros-${index}`; // To target for updates
                // Structure for macros: Kcal: X, Prot: Y, Carb: Z, Fat: A
                macrosDiv.innerHTML = `
                    <span class="macro-kcal"></span>
                    <span class="macro-prot"></span>
                    <span class="macro-carb"></span>
                    <span class="macro-fat"></span>
                `;
                li.appendChild(macrosDiv);
                // Populate macros if they exist (e.g., after calculation)
                if (item.calculatedMacros) {
                    updateMacrosDisplay(macrosDiv, item.calculatedMacros);
                }


                // Right part: Remove Button
                const removeBtn = document.createElement('button');
                removeBtn.classList.add('meal-item-remove-btn');
                removeBtn.innerHTML = '&times;'; // 'X' symbol
                removeBtn.title = 'Remove ingredient';
                removeBtn.onclick = () => {
                    currentMeal.splice(index, 1);
                    renderCurrentMeal();
                    if (currentMeal.length === 0) calculateNutritionBtn.disabled = true;
                     // If nutrition results are visible, prompt for recalculation
                    if (nutritionResultsSection.style.display !== 'none') {
                        nutritionStatus.textContent = 'Meal composition changed (item removed). Please recalculate.';
                        nutritionStatus.className = 'status-message info';
                        // Clear or hide old overall results table
                        // totalNutritionTableBody.innerHTML = '';
                        // per100gNutritionTableBody.innerHTML = '';
                    }
                };
                li.appendChild(removeBtn);
                currentMealList.appendChild(li);
            });
        }

        function handleWeightChange(event, index) {
            const newWeight = parseFloat(event.target.value);
            if (!isNaN(newWeight) && newWeight > 0) {
                currentMeal[index].weight = newWeight;
                // Clear its previously calculated macros if any, as they are now stale
                if (currentMeal[index].calculatedMacros) {
                    delete currentMeal[index].calculatedMacros;
                    const macrosDiv = document.getElementById(`macros-${index}`);
                    if (macrosDiv) {
                         updateMacrosDisplay(macrosDiv, null); // Clear display
                    }
                }
                if (nutritionResultsSection.style.display !== 'none') {
                    nutritionStatus.textContent = 'Meal composition changed. Please recalculate for overall totals.';
                    nutritionStatus.className = 'status-message info';
                    // Optionally clear overall totals tables
                    // totalNutritionTableBody.innerHTML = '';
                    // per100gNutritionTableBody.innerHTML = '';
                }
            } else {
                event.target.value = currentMeal[index].weight; // Reset to old value
                mealIngredientStatus.textContent = 'Invalid weight. Please enter a positive number.';
                mealIngredientStatus.className = 'status-message error';
                setTimeout(() => { mealIngredientStatus.textContent = ''; mealIngredientStatus.className = 'status-message'; }, 3000);
            }
        }

        function updateMacrosDisplay(macrosDiv, macros) {
            const kcalSpan = macrosDiv.querySelector('.macro-kcal');
            const protSpan = macrosDiv.querySelector('.macro-prot');
            const carbSpan = macrosDiv.querySelector('.macro-carb');
            const fatSpan = macrosDiv.querySelector('.macro-fat');

            if (macros) {
                kcalSpan.textContent = `kcal: ${macros.calories.toFixed(0)}`;
                protSpan.textContent = `Prot.: ${macros.protein_g.toFixed(1)}g`;
                carbSpan.textContent = `Carb.: ${macros.carbs_g.toFixed(1)}g`;
                fatSpan.textContent = `Fat: ${macros.fat_g.toFixed(1)}g`;
            } else {
                // Clear display
                kcalSpan.textContent = '';
                protSpan.textContent = '';
                carbSpan.textContent = '';
                fatSpan.textContent = '';
            }
        }


        calculateNutritionBtn.addEventListener('click', async () => {
            if (currentMeal.length === 0) {
                nutritionStatus.textContent = 'Cannot calculate nutrition for an empty meal.';
                nutritionStatus.className = 'status-message error';
                nutritionResultsSection.style.display = 'block';
                return;
            }

            const mealPayload = {
                name: mealNameInput.value || 'My Custom Meal',
                ingredients: currentMeal.map(item => ({ name: item.name, weight: item.weight }))
            };

            nutritionStatus.textContent = 'Calculating...';
            nutritionStatus.className = 'status-message info';
            nutritionResultsSection.style.display = 'block';


            try {
                const response = await fetch('/api/calculate_meal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mealPayload)
                });

                const result = await response.json();
                nutritionStatus.textContent = ''; // Clear calculating message

                if (response.ok && result.success) {
                    displayNutritionResults(result.meal_name, result.total_nutrition, result.nutrition_per_100g, result.ingredients_list);
                } else {
                    nutritionStatus.textContent = result.message || 'Error calculating nutrition.';
                    nutritionStatus.className = 'status-message error';
                    totalNutritionTableBody.innerHTML = '';
                    per100gNutritionTableBody.innerHTML = '';
                }
            } catch (error) {
                console.error('Error calculating nutrition:', error);
                nutritionStatus.textContent = 'An unexpected error occurred. Please try again.';
                nutritionStatus.className = 'status-message error';
                totalNutritionTableBody.innerHTML = '';
                per100gNutritionTableBody.innerHTML = '';
            }
        });

        function displayNutritionResults(name, totalNutrition, per100gNutrition, ingredientsList) {
            resultMealName.textContent = name;

            // Store calculated macros for each ingredient back into the currentMeal array
            // ingredientsList comes from the server and contains calculated values per item
            ingredientsList.forEach((calculatedItem, index) => {
                if (currentMeal[index] && currentMeal[index].name === calculatedItem.name) {
                    currentMeal[index].calculatedMacros = {
                        calories: calculatedItem.calories,
                        protein_g: calculatedItem.protein_g,
                        carbs_g: calculatedItem.carbs_g,
                        fat_g: calculatedItem.fat_g
                    };
                }
            });

            // Re-render the current meal list to show these new macros
            renderCurrentMeal();

            totalNutritionTableBody.innerHTML = ''; // Clear previous results
            populateTable(totalNutritionTableBody, [
                { nutrient: 'Total Weight', amount: `${totalNutrition.total_weight_g.toFixed(1)}g` },
                { nutrient: 'Total Calories', amount: `${totalNutrition.total_calories.toFixed(1)} kcal` },
                { nutrient: 'Total Protein', amount: `${totalNutrition.total_protein_g.toFixed(1)}g` },
                { nutrient: 'Total Carbs', amount: `${totalNutrition.total_carbs_g.toFixed(1)}g` },
                { nutrient: 'Total Fat', amount: `${totalNutrition.total_fat_g.toFixed(1)}g` }
            ]);

            per100gNutritionTableBody.innerHTML = ''; // Clear previous results
            if (per100gNutrition.calories_per_100g !== null) {
                populateTable(per100gNutritionTableBody, [
                    { nutrient: 'Calories per 100g', amount: `${per100gNutrition.calories_per_100g.toFixed(1)} kcal` },
                    { nutrient: 'Protein per 100g', amount: `${per100gNutrition.protein_per_100g.toFixed(1)}g` },
                    { nutrient: 'Carbs per 100g', amount: `${per100gNutrition.carbs_per_100g.toFixed(1)}g` },
                    { nutrient: 'Fat per 100g', amount: `${per100gNutrition.fat_per_100g.toFixed(1)}g` }
                ]);
            } else {
                 const row = per100gNutritionTableBody.insertRow();
                 const cell = row.insertCell();
                 cell.colSpan = 2;
                 cell.textContent = 'N/A (meal weight is zero)';
            }
            nutritionResultsSection.style.display = 'block';
            nutritionStatus.textContent = 'Calculation successful!';
            nutritionStatus.className = 'status-message success';
        }

        function populateTable(tbody, data) {
            data.forEach(item => {
                const row = tbody.insertRow();
                const cellNutrient = row.insertCell();
                const cellAmount = row.insertCell();
                cellNutrient.textContent = item.nutrient;
                cellAmount.textContent = item.amount;
            });
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            fetchIngredients();
            renderCurrentMeal(); // To show "No ingredients added yet."
        });

        // Global Shutdown server button event listener
        const globalShutdownBtn = document.getElementById('globalShutdownBtn');
        if (globalShutdownBtn) {
            globalShutdownBtn.addEventListener('click', async function() {
                try {
                    await fetch('/shutdown-server');
                    globalShutdownBtn.innerHTML = "&check;";
                    globalShutdownBtn.title = "Server shutting down";
                    globalShutdownBtn.disabled = true;
                    // Display a message on the page
                    let msgDiv = document.createElement('div');
                    msgDiv.style.position = 'fixed';
                    msgDiv.style.top = '50%';
                    msgDiv.style.left = '50%';
                    msgDiv.style.transform = 'translate(-50%, -50%)';
                    msgDiv.style.padding = '20px';
                    msgDiv.style.backgroundColor = 'lightgreen';
                    msgDiv.style.border = '1px solid green';
                    msgDiv.style.borderRadius = '5px';
                    msgDiv.style.zIndex = '1001';
                    msgDiv.textContent = 'Server shutdown initiated. You may close this window.';
                    document.body.appendChild(msgDiv);
                } catch (error) {
                    console.error('Error sending shutdown command:', error);
                    alert('Failed to send shutdown command. The server might already be down or unreachable.');
                }
            });
        }
    </script>
</body>
</html>
