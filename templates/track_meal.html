<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Meal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button id="globalShutdownBtn" class="global-shutdown-button" title="Shutdown Server">
        &times; <!-- This is the 'X' symbol -->
        <span class="tooltip-text">Shutdown Server</span>
    </button>

    <div class="container">
        <header>
            <h1>Track Your Meal</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('add_ingredient_page') }}" class="nav-link">Add Ingredient</a>
            </nav>
        </header>

        <section id="mealCompositionSection">
            <h2>Compose Your Meal</h2>
            <div class="form-group">
                <label for="mealName">Meal Name:</label>
                <input type="text" id="mealName" name="mealName" value="My Custom Meal">
            </div>

            <div class="ingredient-selector">
                <div class="form-group">
                    <label for="ingredientSearch">Select Ingredient:</label>
                    <input type="text" id="ingredientSearch" placeholder="Search ingredients...">
                    <select id="ingredientSelect" name="ingredientSelect" size="5"></select>
                </div>
                <div class="form-group">
                    <label for="ingredientWeight">Weight (grams):</label>
                    <input type="number" id="ingredientWeight" name="ingredientWeight" min="0" step="0.1" placeholder="e.g., 150">
                </div>
                <button id="addIngredientToMealBtn" class="button">Add to Meal</button>
            </div>
            <div id="mealIngredientStatus" class="status-message" style="margin-top: 10px;"></div>
        </section>

        <section id="currentMealSection">
            <h2>Current Meal Ingredients</h2>
            <ul id="currentMealList">
                <!-- Ingredients will be listed here by JavaScript -->
            </ul>
            <button id="calculateNutritionBtn" class="button primary-action" disabled>Calculate Nutrition</button>
        </section>

        <section id="nutritionResultsSection" style="display:none;">
            <h2>Nutritional Information for <span id="resultMealName"></span></h2>
            <div id="nutritionStatus" class="status-message"></div>
            <h3>Total Meal Nutrition:</h3>
            <table id="totalNutritionTable">
                <thead>
                    <tr>
                        <th>Nutrient</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>

            <h3>Nutrition per 100g of Meal:</h3>
            <table id="per100gNutritionTable">
                <thead>
                    <tr>
                        <th>Nutrient</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        const mealNameInput = document.getElementById('mealName');
        const ingredientSearch = document.getElementById('ingredientSearch');
        const ingredientSelect = document.getElementById('ingredientSelect');
        const ingredientWeightInput = document.getElementById('ingredientWeight');
        const addIngredientToMealBtn = document.getElementById('addIngredientToMealBtn');
        const currentMealList = document.getElementById('currentMealList');
        const calculateNutritionBtn = document.getElementById('calculateNutritionBtn');
        const nutritionResultsSection = document.getElementById('nutritionResultsSection');
        const resultMealName = document.getElementById('resultMealName');
        const totalNutritionTableBody = document.getElementById('totalNutritionTable').getElementsByTagName('tbody')[0];
        const per100gNutritionTableBody = document.getElementById('per100gNutritionTable').getElementsByTagName('tbody')[0];
        const mealIngredientStatus = document.getElementById('mealIngredientStatus');
        const nutritionStatus = document.getElementById('nutritionStatus');

        let availableIngredients = [];
        let currentMeal = []; // Array of {name, weight, originalData}

        async function fetchIngredients() {
            try {
                const response = await fetch('/api/get_ingredients');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                availableIngredients = await response.json();
                populateIngredientSelect(availableIngredients);
            } catch (error) {
                console.error('Error fetching ingredients:', error);
                mealIngredientStatus.textContent = 'Error loading ingredients. Please try refreshing.';
                mealIngredientStatus.className = 'status-message error';
            }
        }

        function populateIngredientSelect(ingredients) {
            ingredientSelect.innerHTML = ''; // Clear existing options
            ingredients.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.name;
                option.textContent = ing.name; // Display only the name

                // Create tooltip content
                const tooltipText = `Calories: ${ing.calories.toFixed(1)} kcal\nProtein: ${ing.protein.toFixed(1)} g\nCarbs: ${ing.carbs.toFixed(1)} g\nFat: ${ing.fat.toFixed(1)} g\n(per 100g)`;
                option.title = tooltipText; // Use the native title attribute for simple tooltips

                ingredientSelect.appendChild(option);
            });
        }

        ingredientSearch.addEventListener('input', () => {
            const searchTerm = ingredientSearch.value.toLowerCase();
            const filteredIngredients = availableIngredients.filter(ing => ing.name.toLowerCase().includes(searchTerm));
            populateIngredientSelect(filteredIngredients);
        });

        addIngredientToMealBtn.addEventListener('click', () => {
            const selectedOption = ingredientSelect.options[ingredientSelect.selectedIndex];
            const weight = parseFloat(ingredientWeightInput.value);

            mealIngredientStatus.textContent = '';
            mealIngredientStatus.className = 'status-message';

            if (!selectedOption) {
                mealIngredientStatus.textContent = 'Please select an ingredient.';
                mealIngredientStatus.className = 'status-message error';
                return;
            }
            if (isNaN(weight) || weight <= 0) {
                mealIngredientStatus.textContent = 'Please enter a valid positive weight.';
                mealIngredientStatus.className = 'status-message error';
                return;
            }

            const ingredientName = selectedOption.value;
            const ingredientData = availableIngredients.find(ing => ing.name === ingredientName);

            if (ingredientData) {
                currentMeal.push({ name: ingredientName, weight: weight, originalData: ingredientData });
                renderCurrentMeal();
                ingredientWeightInput.value = ''; // Clear weight input
                calculateNutritionBtn.disabled = false;
                mealIngredientStatus.textContent = `${ingredientName} added to meal.`;
                mealIngredientStatus.className = 'status-message success';
                 setTimeout(() => { mealIngredientStatus.textContent = ''; mealIngredientStatus.className = 'status-message';}, 3000);
            } else {
                mealIngredientStatus.textContent = 'Selected ingredient not found in available list.';
                mealIngredientStatus.className = 'status-message error';
            }
        });

        function renderCurrentMeal() {
            currentMealList.innerHTML = ''; // Clear existing list
            if (currentMeal.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No ingredients added yet.';
                currentMealList.appendChild(li);
                calculateNutritionBtn.disabled = true;
                return;
            }
            currentMeal.forEach((item, index) => {
                const li = document.createElement('li');

                // Ingredient Name Span
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${item.name} - `;
                li.appendChild(nameSpan);

                // Editable Weight Input
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.value = item.weight;
                weightInput.min = "0.1"; // Smallest reasonable weight
                weightInput.step = "0.1";
                weightInput.classList.add('editable-weight-input'); // For styling
                weightInput.dataset.index = index; // Store index for easy update

                weightInput.addEventListener('change', (event) => {
                    const newWeight = parseFloat(event.target.value);
                    const itemIndex = parseInt(event.target.dataset.index);
                    if (!isNaN(newWeight) && newWeight > 0) {
                        currentMeal[itemIndex].weight = newWeight;
                        // If nutrition results are visible, maybe offer a "Recalculate" button or clear them
                        if (nutritionResultsSection.style.display !== 'none') {
                            nutritionStatus.textContent = 'Meal composition changed. Please recalculate.';
                            nutritionStatus.className = 'status-message info';
                            // Optionally hide old results or disable calculate button until re-rendered
                        }
                    } else {
                        // Reset to old value if input is invalid
                        event.target.value = currentMeal[itemIndex].weight;
                        mealIngredientStatus.textContent = 'Invalid weight. Please enter a positive number.';
                        mealIngredientStatus.className = 'status-message error';
                        setTimeout(() => { mealIngredientStatus.textContent = ''; mealIngredientStatus.className = 'status-message';}, 3000);
                    }
                });
                li.appendChild(weightInput);

                const unitSpan = document.createElement('span');
                unitSpan.textContent = "g";
                li.appendChild(unitSpan);

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.classList.add('remove-btn');
                removeBtn.onclick = () => {
                    currentMeal.splice(index, 1);
                    renderCurrentMeal();
                     if (currentMeal.length === 0) calculateNutritionBtn.disabled = true;
                };
                li.appendChild(removeBtn);
                currentMealList.appendChild(li);
            });
        }

        calculateNutritionBtn.addEventListener('click', async () => {
            if (currentMeal.length === 0) {
                nutritionStatus.textContent = 'Cannot calculate nutrition for an empty meal.';
                nutritionStatus.className = 'status-message error';
                nutritionResultsSection.style.display = 'block';
                return;
            }

            const mealPayload = {
                name: mealNameInput.value || 'My Custom Meal',
                ingredients: currentMeal.map(item => ({ name: item.name, weight: item.weight }))
            };

            nutritionStatus.textContent = 'Calculating...';
            nutritionStatus.className = 'status-message info';
            nutritionResultsSection.style.display = 'block';


            try {
                const response = await fetch('/api/calculate_meal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mealPayload)
                });

                const result = await response.json();
                nutritionStatus.textContent = ''; // Clear calculating message

                if (response.ok && result.success) {
                    displayNutritionResults(result.meal_name, result.total_nutrition, result.nutrition_per_100g, result.ingredients_list);
                } else {
                    nutritionStatus.textContent = result.message || 'Error calculating nutrition.';
                    nutritionStatus.className = 'status-message error';
                    totalNutritionTableBody.innerHTML = '';
                    per100gNutritionTableBody.innerHTML = '';
                }
            } catch (error) {
                console.error('Error calculating nutrition:', error);
                nutritionStatus.textContent = 'An unexpected error occurred. Please try again.';
                nutritionStatus.className = 'status-message error';
                totalNutritionTableBody.innerHTML = '';
                per100gNutritionTableBody.innerHTML = '';
            }
        });

        function displayNutritionResults(name, totalNutrition, per100gNutrition, ingredientsList) {
            resultMealName.textContent = name;

            // The currentMealList is already rendered with editable inputs by renderCurrentMeal().
            // We should not overwrite it here with static text.
            // If details of individual calculated ingredients are needed, they could go into a new table or section.
            // For now, we will leave currentMealList as is.

            // If you want to display the calculated nutrition for each item in the list (after calculation):
            // You could iterate through currentMeal and ingredientsList (which should match in order and items)
            // and update a specific part of each <li> in currentMealList, or add a new details section.
            // This adds complexity. The current setup with editable fields in currentMealList and
            // separate summary tables for total and per-100g seems reasonable.

            totalNutritionTableBody.innerHTML = ''; // Clear previous results
            populateTable(totalNutritionTableBody, [
                { nutrient: 'Total Weight', amount: `${totalNutrition.total_weight_g.toFixed(1)}g` },
                { nutrient: 'Total Calories', amount: `${totalNutrition.total_calories.toFixed(1)} kcal` },
                { nutrient: 'Total Protein', amount: `${totalNutrition.total_protein_g.toFixed(1)}g` },
                { nutrient: 'Total Carbs', amount: `${totalNutrition.total_carbs_g.toFixed(1)}g` },
                { nutrient: 'Total Fat', amount: `${totalNutrition.total_fat_g.toFixed(1)}g` }
            ]);

            per100gNutritionTableBody.innerHTML = ''; // Clear previous results
            if (per100gNutrition.calories_per_100g !== null) {
                populateTable(per100gNutritionTableBody, [
                    { nutrient: 'Calories per 100g', amount: `${per100gNutrition.calories_per_100g.toFixed(1)} kcal` },
                    { nutrient: 'Protein per 100g', amount: `${per100gNutrition.protein_per_100g.toFixed(1)}g` },
                    { nutrient: 'Carbs per 100g', amount: `${per100gNutrition.carbs_per_100g.toFixed(1)}g` },
                    { nutrient: 'Fat per 100g', amount: `${per100gNutrition.fat_per_100g.toFixed(1)}g` }
                ]);
            } else {
                 const row = per100gNutritionTableBody.insertRow();
                 const cell = row.insertCell();
                 cell.colSpan = 2;
                 cell.textContent = 'N/A (meal weight is zero)';
            }
            nutritionResultsSection.style.display = 'block';
            nutritionStatus.textContent = 'Calculation successful!';
            nutritionStatus.className = 'status-message success';
        }

        function populateTable(tbody, data) {
            data.forEach(item => {
                const row = tbody.insertRow();
                const cellNutrient = row.insertCell();
                const cellAmount = row.insertCell();
                cellNutrient.textContent = item.nutrient;
                cellAmount.textContent = item.amount;
            });
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            fetchIngredients();
            renderCurrentMeal(); // To show "No ingredients added yet."
        });

        // Global Shutdown server button event listener
        const globalShutdownBtn = document.getElementById('globalShutdownBtn');
        if (globalShutdownBtn) {
            globalShutdownBtn.addEventListener('click', async function() {
                try {
                    await fetch('/shutdown-server');
                    globalShutdownBtn.innerHTML = "&check;";
                    globalShutdownBtn.title = "Server shutting down";
                    globalShutdownBtn.disabled = true;
                    // Display a message on the page
                    let msgDiv = document.createElement('div');
                    msgDiv.style.position = 'fixed';
                    msgDiv.style.top = '50%';
                    msgDiv.style.left = '50%';
                    msgDiv.style.transform = 'translate(-50%, -50%)';
                    msgDiv.style.padding = '20px';
                    msgDiv.style.backgroundColor = 'lightgreen';
                    msgDiv.style.border = '1px solid green';
                    msgDiv.style.borderRadius = '5px';
                    msgDiv.style.zIndex = '1001';
                    msgDiv.textContent = 'Server shutdown initiated. You may close this window.';
                    document.body.appendChild(msgDiv);
                } catch (error) {
                    console.error('Error sending shutdown command:', error);
                    alert('Failed to send shutdown command. The server might already be down or unreachable.');
                }
            });
        }
    </script>
</body>
</html>
